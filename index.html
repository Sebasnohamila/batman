<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <title>Visor 3D - Auto Centrado</title>

        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

        <style>
            body { margin: 0; overflow: hidden; font-family: monospace; background-color: #333; }
            
            #splash-screen {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: white; z-index: 9999;
                display: flex; flex-direction: column; 
                justify-content: center; align-items: center;
            }
            #splash-screen button {
                padding: 20px 40px; font-size: 20px; background: black; color: gold;
                border: 2px solid gold; border-radius: 10px; cursor: pointer;
            }

            /* Consola de depuración en pantalla */
            #debug-console {
                position: fixed; top: 0; left: 0; width: 100%; 
                background: rgba(0,0,0,0.8); color: lime; padding: 10px; 
                pointer-events: none; z-index: 9990; font-size: 14px;
            }
        </style>

        <script>
            // --- LOG EN PANTALLA ---
            function log(text) {
                console.log(text);
                var el = document.getElementById('debug-console');
                if(el) el.innerText += "\n" + text;
            }

            // --- COMPONENTE MÁGICO: AUTO-AJUSTE ---
            AFRAME.registerComponent('auto-adjust-model', {
                init: function () {
                    this.el.addEventListener('model-loaded', (e) => {
                        log(">> Modelo cargado. Calculando geometría...");
                        
                        const object = e.detail.model;
                        
                        // 1. Calcular la caja delimitadora (Bounding Box)
                        const box = new THREE.Box3().setFromObject(object);
                        const size = new THREE.Vector3();
                        box.getSize(size);
                        const center = new THREE.Vector3();
                        box.getCenter(center);

                        log(`>> Tamaño original: X:${size.x.toFixed(2)} Y:${size.y.toFixed(2)} Z:${size.z.toFixed(2)}`);
                        log(`>> Centro original desviado en: X:${center.x.toFixed(2)}`);

                        // 2. Resetear posición del objeto interno para centrarlo en su propio eje
                        object.position.x += (object.position.x - center.x);
                        object.position.y += (object.position.y - center.y);
                        object.position.z += (object.position.z - center.z);

                        // 3. Calcular escala para que mida aprox 2 unidades de alto (visible en cámara)
                        const maxDimension = Math.max(size.x, size.y, size.z);
                        
                        if (maxDimension === 0) {
                            log("ERROR CRÍTICO: El modelo tiene tamaño 0. Archivo corrupto.");
                            return;
                        }

                        const targetSize = 2.0; // Queremos que mida 2 metros
                        const scaleFactor = targetSize / maxDimension;

                        // Aplicar escala al contenedor de A-Frame
                        this.el.object3D.scale.set(scaleFactor, scaleFactor, scaleFactor);
                        
                        log(`>> RE-ESCALADO A: ${scaleFactor.toFixed(4)}`);
                        log(">> Modelo centrado y listo.");

                        // 4. Arreglar materiales oscuros
                        object.traverse((node) => {
                            if (node.isMesh) {
                                node.material.metalness = 0;
                                node.material.needsUpdate = true;
                            }
                        });
                        
                        // 5. Iniciar animación si existe
                        this.el.setAttribute('animation-mixer', 'timeScale: 1');
                    });

                    this.el.addEventListener('model-error', (e) => {
                        log("ERROR: No se pudo cargar el archivo .GLB");
                    });
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const splash = document.getElementById('splash-screen');
                const btn = document.querySelector('#splash-screen button');
                const video = document.getElementById('vid');
                const model = document.getElementById('animatedModel');

                btn.addEventListener('click', () => {
                    splash.style.display = 'none';
                    model.setAttribute('visible', 'true');
                    if(video) video.play();
                });

                // --- GESTOS SIMPLES (ROTACIÓN Y ZOOM) ---
                let startX = 0;
                
                window.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 1) {
                        let delta = e.touches[0].clientX - startX;
                        startX = e.touches[0].clientX;
                        model.object3D.rotation.y += delta * 0.01;
                    }
                });
                window.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                });
                
                // Zoom rueda mouse
                window.addEventListener('wheel', (e) => {
                    let s = model.object3D.scale.x;
                    s += e.deltaY * -0.001; 
                    s = Math.max(0.0001, s); // Evitar negativos
                    model.object3D.scale.set(s,s,s);
                });
            });
        </script>
    </head>

    <body>
        <div id="debug-console">Iniciando sistema...</div>

        <div id="splash-screen">
            <button>CARGAR MODELO</button>
        </div>

        <a-scene 
            background="color: #4da6ff" 
            renderer="logarithmicDepthBuffer: true;"
            vr-mode-ui="enabled: false">
            
            <a-assets>
                <video id="vid" src="assets/batman.mp4" loop crossorigin playsinline></video>
                <a-asset-item id="miModelo" src="assets/spiderman.glb"></a-asset-item>
            </a-assets>

            <a-entity light="type: ambient; intensity: 2"></a-entity>
            <a-entity light="type: directional; intensity: 1.5" position="1 1 2"></a-entity>

            <a-entity camera position="0 0 3" look-controls="enabled: false"></a-entity>

            <a-entity 
                id="animatedModel" 
                gltf-model="#miModelo" 
                visible="false"
                auto-adjust-model>
            </a-entity>

        </a-scene>
    </body>
</html>

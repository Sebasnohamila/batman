<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Experiencia 3D Bhastian - Optimizado</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <style>
        /* Fondo negro para toda la página */
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: #000; }

        /* --- PANEL DE DATOS (DEBUG MODE) --- */
        #debug-panel {
            position: fixed;
            top: 0; left: 0; width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff00; /* Texto verde */
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none; 
            text-align: center;
            display: none; 
        }

        /* --- UI DE CARGA --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; /* Fondo negro en carga también */
            z-index: 9999;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }

        #logo-img { max-width: 50%; height: auto; margin-bottom: 20px; }

        .loader {
            border: 5px solid #333;
            border-top: 5px solid #D4AF37;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #start-btn {
            display: none;
            padding: 15px 30px;
            background-color: #D4AF37;
            color: #000;
            border: none;
            font-size: 18px; font-weight: bold;
            cursor: pointer; border-radius: 25px;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        #whatsapp-button {
            position: fixed; bottom: 20px; right: 20px; z-index: 9998;
            display: none;
        }
        #whatsapp-button img { width: 50px; height: 50px; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); }
    </style>

    <script>
        AFRAME.registerComponent('model-viewer', {
            init: function () {
                this.model = this.el;
                this.isInteractable = false;

                // Variables de gestos
                this.startX = 0;
                this.startY = 0;
                this.initialScaleVector = new THREE.Vector3();
                this.initialDistance = 0;

                // --- CONFIGURACIÓN DE LÍMITES ---
                this.limitRad = 30 * (Math.PI / 180); // 30 grados max rotación
                
                // Aquí definimos el zoom:
                // minScale: No dejará hacer zoom out más allá del tamaño inicial
                this.baseScale = 0.012; 
                this.minScale = 0.012; 
                this.maxScale = 0.035; // Cuánto permites acercar (zoom in)

                // UI Elements
                const uiLayer = document.getElementById('ui-layer');
                const loader = document.querySelector('.loader');
                const startBtn = document.getElementById('start-btn');
                const waBtn = document.getElementById('whatsapp-button');
                const videoAudio = document.getElementById('vid');
                const debugPanel = document.getElementById('debug-panel');

                // --- OPTIMIZACIÓN DE RENDIMIENTO (CRÍTICO PARA CELULAR) ---
                // Esto hace que vaya rápido limitando la resolución de renderizado
                this.el.sceneEl.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));

                this.el.addEventListener('model-loaded', () => {
                    loader.style.display = 'none';
                    startBtn.style.display = 'block';
                    
                    // Corrección materiales
                    this.el.object3D.traverse((node) => {
                        if (node.isMesh && node.material) {
                            node.material.metalness = 0;
                            node.material.roughness = 1;
                        }
                    });
                });

                startBtn.addEventListener('click', () => {
                    uiLayer.style.opacity = '0';
                    setTimeout(() => { uiLayer.style.display = 'none'; }, 500);

                    this.isInteractable = true;
                    waBtn.style.display = 'block';
                    debugPanel.style.display = 'block'; 

                    if(videoAudio) {
                        videoAudio.play().then(() => { videoAudio.volume = 1.0; })
                        .catch(e => console.error(e));
                    }
                    this.el.setAttribute('animation-mixer', 'timeScale: 1');
                    this.updateDebugInfo();
                });

                // Función para mostrar datos en pantalla
                this.updateDebugInfo = () => {
                    const s = this.el.object3D.scale.x.toFixed(5);
                    const rx = (this.el.object3D.rotation.x * (180/Math.PI)).toFixed(1);
                    const ry = (this.el.object3D.rotation.y * (180/Math.PI)).toFixed(1);
                    const px = this.el.object3D.position.x.toFixed(3);
                    const py = this.el.object3D.position.y.toFixed(3);
                    const pz = this.el.object3D.position.z.toFixed(3);
                    
                    debugPanel.innerHTML = `
                        POSICIÓN(x,y,z): [${px} ${py} ${pz}] | 
                        ROTACIÓN: ${rx}° ${ry}° | 
                        ESCALA FINAL: ${s}
                    `;
                };

                // --- TOUCH START ---
                window.addEventListener('touchstart', (e) => {
                    if (!this.isInteractable) return;
                    if (e.touches.length === 1) {
                        this.startX = e.touches[0].clientX;
                        this.startY = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        this.initialDistance = Math.sqrt(dx * dx + dy * dy);
                        this.initialScaleVector.copy(this.el.object3D.scale);
                    }
                });

                // --- TOUCH MOVE ---
                window.addEventListener('touchmove', (e) => {
                    if (!this.isInteractable) return;

                    if (e.touches.length === 1) {
                        // ROTACIÓN
                        const deltaX = e.touches[0].clientX - this.startX;
                        const deltaY = e.touches[0].clientY - this.startY;

                        this.startX = e.touches[0].clientX;
                        this.startY = e.touches[0].clientY;

                        const speed = 0.005;

                        let newRotY = this.el.object3D.rotation.y + (deltaX * speed);
                        newRotY = Math.max(-this.limitRad, Math.min(this.limitRad, newRotY));
                        this.el.object3D.rotation.y = newRotY;

                        let newRotX = this.el.object3D.rotation.x + (deltaY * speed);
                        newRotX = Math.max(-this.limitRad, Math.min(this.limitRad, newRotX));
                        this.el.object3D.rotation.x = newRotX;

                    } else if (e.touches.length === 2 && this.initialDistance > 0) {
                        // ZOOM
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const currentDistance = Math.sqrt(dx * dx + dy * dy);
                        
                        const scaleFactor = currentDistance / this.initialDistance;

                        let newS = this.initialScaleVector.x * scaleFactor;
                        
                        // LÓGICA DE LIMITACIÓN DE ZOOM:
                        // Math.max(this.minScale, ...) -> Impide que sea menor que el inicio
                        newS = Math.max(this.minScale, Math.min(this.maxScale, newS));

                        this.el.object3D.scale.set(newS, newS, newS);
                    }
                    this.updateDebugInfo();
                });
            }
        });
    </script>
</head>

<body>
    <div id="debug-panel">Esperando carga...</div>

    <div id="ui-layer">
        <img id="logo-img" src="assets/logo.png" alt="Bhastian Logo">
        <div class="loader"></div>
        <button id="start-btn">VER EXPERIENCIA</button>
    </div>

    <a href="https://wa.me/593983088889" target="_blank" id="whatsapp-button">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <a-scene 
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: false; highRefreshRate: true;"
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false"
        background="color: #000000"> <a-assets>
            <video id="vid" src="assets/assetspiderman.mp4" preload="auto" loop crossorigin="anonymous" playsinline></video>
            <a-asset-item id="miModelo" src="assets/spiderman.glb"></a-asset-item>
        </a-assets>

        <a-entity light="type: ambient; intensity: 1; color: #ffffff"></a-entity>
        <a-entity light="type: directional; intensity: 1.5" position="2 4 4"></a-entity>

        <a-entity camera position="0 1.6 3.5" look-controls="enabled: false"></a-entity>

        <a-entity 
            id="animatedModel"
            gltf-model="#miModelo"
            scale="0.012 0.012 0.012"
            position="0 0 0" 
            rotation="0 0 0"
            model-viewer
        ></a-entity>

    </a-scene>
</body>
</html>

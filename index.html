<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Experiencia 3D Bhastian - Limitada</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: #111; }

        /* --- PANTALLA DE CARGA Y BIENVENIDA --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: white; z-index: 9999;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }

        #logo-img {
            max-width: 50%;
            height: auto;
            margin-bottom: 20px;
        }

        /* Rueda de carga */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #D4AF37; /* Color dorado para Bhastian */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: block; /* Visible al inicio */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Botón de Ver Experiencia (Oculto al inicio) */
        #start-btn {
            display: none;
            padding: 15px 30px;
            background-color: #000;
            color: #D4AF37; /* Dorado */
            border: 2px solid #D4AF37;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #start-btn:active { transform: scale(0.95); }

        /* Botón WhatsApp */
        #whatsapp-button {
            position: fixed; bottom: 20px; right: 20px; z-index: 9998;
            display: none; /* Se muestra al entrar */
        }
        #whatsapp-button img { width: 50px; height: 50px; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); }

    </style>

    <script>
        // --- COMPONENTE: CONTROLADOR DEL VISOR 3D ---
        AFRAME.registerComponent('model-viewer', {
            init: function () {
                this.model = this.el;
                this.isInteractable = false;

                // Variables para gestos
                this.startX = 0;
                this.startY = 0;
                this.initialScaleVector = new THREE.Vector3();
                this.initialDistance = 0;

                // --- CAMBIO AQUI: Límite de 30 grados ---
                // Convertimos 30 grados a radianes (30 * PI / 180)
                this.limitRad = 30 * (Math.PI / 180); 
                // Esto equivale aproximadamente a 0.52 radianes

                // --- MANEJO DE LA CARGA ---
                const uiLayer = document.getElementById('ui-layer');
                const loader = document.querySelector('.loader');
                const startBtn = document.getElementById('start-btn');
                const waBtn = document.getElementById('whatsapp-button');
                const videoAudio = document.getElementById('vid');

                // Cuando el modelo 3D se carga completamente
                this.el.addEventListener('model-loaded', () => {
                    console.log("Modelo cargado. Listo para mostrar botón.");
                    loader.style.display = 'none';
                    startBtn.style.display = 'block';
                    
                    // Corrección materiales (evitar que se vean negros)
                    this.el.object3D.traverse((node) => {
                        if (node.isMesh && node.material) {
                            node.material.metalness = 0;
                            node.material.roughness = 1;
                        }
                    });
                });

                // Acción del botón "VER EXPERIENCIA"
                startBtn.addEventListener('click', () => {
                    uiLayer.style.opacity = '0';
                    setTimeout(() => { uiLayer.style.display = 'none'; }, 500);

                    this.isInteractable = true;
                    waBtn.style.display = 'block';

                    if(videoAudio) {
                        videoAudio.play().then(() => {
                            videoAudio.volume = 1.0;
                        }).catch(e => console.error("Error audio:", e));
                    }
                    this.el.setAttribute('animation-mixer', 'timeScale: 1');
                });

                // --- GESTOS TÁCTILES ---
                
                // Touch Start (Guardar posición inicial)
                window.addEventListener('touchstart', (e) => {
                    if (!this.isInteractable) return;

                    if (e.touches.length === 1) {
                        this.startX = e.touches[0].clientX;
                        this.startY = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        this.initialDistance = Math.sqrt(dx * dx + dy * dy);
                        this.initialScaleVector.copy(this.el.object3D.scale);
                    }
                });

                // Touch Move (Rotación limitada y Zoom)
                window.addEventListener('touchmove', (e) => {
                    if (!this.isInteractable) return;

                    if (e.touches.length === 1) {
                        // --- ROTACIÓN (1 dedo) ---
                        const deltaX = e.touches[0].clientX - this.startX;
                        const deltaY = e.touches[0].clientY - this.startY;

                        this.startX = e.touches[0].clientX;
                        this.startY = e.touches[0].clientY;

                        // Velocidad de giro (ajusta si es muy rápido/lento)
                        const speed = 0.005;

                        // 1. Calcular rotación Y (Izquierda/Derecha)
                        let newRotY = this.el.object3D.rotation.y + (deltaX * speed);
                        // 2. CLAMP: Limitar entre -30 grados y +30 grados
                        newRotY = Math.max(-this.limitRad, Math.min(this.limitRad, newRotY));
                        this.el.object3D.rotation.y = newRotY;

                        // 3. Calcular rotación X (Arriba/Abajo)
                        let newRotX = this.el.object3D.rotation.x + (deltaY * speed);
                        // 4. CLAMP: Limitar entre -30 grados y +30 grados
                        newRotX = Math.max(-this.limitRad, Math.min(this.limitRad, newRotX));
                        this.el.object3D.rotation.x = newRotX;

                    } else if (e.touches.length === 2 && this.initialDistance > 0) {
                        // --- ZOOM (2 dedos) ---
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const currentDistance = Math.sqrt(dx * dx + dy * dy);
                        
                        const scaleFactor = currentDistance / this.initialDistance;

                        let newX = this.initialScaleVector.x * scaleFactor;
                        let newY = this.initialScaleVector.y * scaleFactor;
                        let newZ = this.initialScaleVector.z * scaleFactor;

                        // Límites del Zoom (Ajusta estos valores según tu modelo)
                        const minScale = 0.005; // Zoom máximo (más cerca)
                        const maxScale = 0.03;  // Zoom mínimo (más lejos)

                        newX = Math.max(minScale, Math.min(maxScale, newX));
                        newY = Math.max(minScale, Math.min(maxScale, newY));
                        newZ = Math.max(minScale, Math.min(maxScale, newZ));

                        this.el.object3D.scale.set(newX, newY, newZ);
                    }
                });
            }
        });
    </script>
</head>

<body>
    <div id="ui-layer">
        <img id="logo-img" src="assets/logo.png" alt="Bhastian Logo">
        
        <div class="loader"></div>
        
        <button id="start-btn">VER EXPERIENCIA</button>
    </div>

    <a href="https://wa.me/593983088889?text=Hola%20Bhastian,%20vi%20la%20experiencia%203D." 
       target="_blank" id="whatsapp-button">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <a-scene 
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true;"
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false"
        background="color: #e0e0e0"> <a-assets>
            <video id="vid" src="assets/assetspiderman.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
            <a-asset-item id="miModelo" src="assets/spiderman.glb"></a-asset-item>
        </a-assets>

        <a-entity light="type: ambient; intensity: 1; color: #ffffff"></a-entity>
        <a-entity light="type: directional; intensity: 1.5" position="2 4 4"></a-entity>

        <a-entity camera position="0 1.6 3.5" look-controls="enabled: false"></a-entity>

        <a-entity 
            id="animatedModel"
            gltf-model="#miModelo"
            scale="0.012 0.012 0.012"
            position="0 0 0" 
            rotation="0 0 0"
            model-viewer
        ></a-entity>

    </a-scene>
</body>
</html>

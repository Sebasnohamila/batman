<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Experiencia 3D Bhastian</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <style>
        /* El fondo base es negro (para el 3D) */
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: #000; }

        /* --- UI DE CARGA E INICIO (FONDO BLANCO AQUI) --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; /* <--- CAMBIO: Fondo Blanco */
            z-index: 9999;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
        }

        #logo-img {
            max-width: 60%;
            height: auto;
            margin-bottom: 30px;
        }

        /* Rueda de Carga (Spinner) */
        .loader {
            border: 4px solid #f3f3f3; /* Gris muy claro para fondo blanco */
            border-top: 4px solid #D4AF37; /* Dorado */
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Botón "VER EXPERIENCIA" */
        #start-btn {
            display: none;
            margin-top: 20px;
            padding: 15px 40px;
            background-color: transparent;
            color: #D4AF37; /* Texto Dorado */
            border: 2px solid #D4AF37;
            font-size: 16px; font-weight: bold;
            cursor: pointer; border-radius: 50px;
            text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.3s ease;
        }

        #start-btn:active {
            background-color: #D4AF37;
            color: #fff;
            transform: scale(0.95);
        }

        /* Botón de WhatsApp */
        #whatsapp-button {
            position: fixed; bottom: 20px; right: 20px; z-index: 9998;
            display: none;
            transition: transform 0.2s;
        }
        #whatsapp-button:active { transform: scale(0.9); }
        #whatsapp-button img { width: 60px; height: 60px; filter: drop-shadow(0px 4px 5px rgba(0,0,0,0.5)); }
    </style>

    <script>
        AFRAME.registerComponent('model-viewer', {
            init: function () {
                this.model = this.el;
                this.isInteractable = false;

                // Variables de gestos
                this.startX = 0;
                this.startY = 0;
                this.initialScaleVector = new THREE.Vector3();
                this.initialDistance = 0;

                // CONFIGURACIÓN DE LÍMITES
                this.limitRad = 30 * (Math.PI / 180); // Límite de 30 grados
                
                // CONFIGURACIÓN DE ZOOM
                this.minScale = 0.012; // Tamaño original (no se puede alejar más)
                this.maxScale = 0.035; // Zoom máximo permitido

                // Referencias al DOM
                const uiLayer = document.getElementById('ui-layer');
                const loader = document.querySelector('.loader');
                const startBtn = document.getElementById('start-btn');
                const waBtn = document.getElementById('whatsapp-button');
                const videoAudio = document.getElementById('vid');

                // OPTIMIZACIÓN DE RENDIMIENTO
                this.el.sceneEl.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));

                // 1. Evento: Cuando el modelo 3D termina de cargar
                this.el.addEventListener('model-loaded', () => {
                    console.log("Modelo cargado.");
                    loader.style.display = 'none';   
                    startBtn.style.display = 'block'; 
                    
                    // Corrección de materiales oscuros
                    this.el.object3D.traverse((node) => {
                        if (node.isMesh && node.material) {
                            node.material.metalness = 0;
                            node.material.roughness = 1;
                        }
                    });
                });

                // 2. Evento: Click en "Ver Experiencia"
                startBtn.addEventListener('click', () => {
                    // Desvanecer capa de carga
                    uiLayer.style.opacity = '0';
                    setTimeout(() => { uiLayer.style.display = 'none'; }, 800);

                    // Habilitar interacción y mostrar botón WA
                    this.isInteractable = true;
                    waBtn.style.display = 'block';

                    // Reproducir audio/video
                    if(videoAudio) {
                        videoAudio.play().then(() => { videoAudio.volume = 1.0; })
                        .catch(e => console.error("Error reproduciendo audio:", e));
                    }
                    // Iniciar animación del modelo
                    this.el.setAttribute('animation-mixer', 'timeScale: 1');
                });

                // 3. Gestos Táctiles (Touch Start)
                window.addEventListener('touchstart', (e) => {
                    if (!this.isInteractable) return;
                    if (e.touches.length === 1) {
                        this.startX = e.touches[0].clientX;
                        this.startY = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        this.initialDistance = Math.sqrt(dx * dx + dy * dy);
                        this.initialScaleVector.copy(this.el.object3D.scale);
                    }
                });

                // 4. Gestos Táctiles (Touch Move)
                window.addEventListener('touchmove', (e) => {
                    if (!this.isInteractable) return;

                    if (e.touches.length === 1) {
                        // --- ROTACIÓN ---
                        const deltaX = e.touches[0].clientX - this.startX;
                        const deltaY = e.touches[0].clientY - this.startY;

                        this.startX = e.touches[0].clientX;
                        this.startY = e.touches[0].clientY;

                        const speed = 0.005;

                        // Horizontal (Y)
                        let newRotY = this.el.object3D.rotation.y + (deltaX * speed);
                        newRotY = Math.max(-this.limitRad, Math.min(this.limitRad, newRotY));
                        this.el.object3D.rotation.y = newRotY;

                        // Vertical (X)
                        let newRotX = this.el.object3D.rotation.x + (deltaY * speed);
                        newRotX = Math.max(-this.limitRad, Math.min(this.limitRad, newRotX));
                        this.el.object3D.rotation.x = newRotX;

                    } else if (e.touches.length === 2 && this.initialDistance > 0) {
                        // --- ZOOM ---
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const currentDistance = Math.sqrt(dx * dx + dy * dy);
                        
                        const scaleFactor = currentDistance / this.initialDistance;
                        let newS = this.initialScaleVector.x * scaleFactor;
                        
                        // Limitación del Zoom
                        newS = Math.max(this.minScale, Math.min(this.maxScale, newS));

                        this.el.object3D.scale.set(newS, newS, newS);
                    }
                });
            }
        });
    </script>
</head>

<body>
    <div id="ui-layer">
        <img id="logo-img" src="assets/logo.png" alt="Bhastian Logo">
        <div class="loader"></div>
        <button id="start-btn">VER EXPERIENCIA</button>
    </div>

    <a href="https://wa.me/593983088889?text=Hola%20Bhastian,%20vi%20su%20experiencia%203D" 
       target="_blank" id="whatsapp-button">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <a-scene 
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: false;"
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false"
        background="color: #000000">

        <a-assets>
            <video id="vid" src="assets/assetspiderman.mp4" preload="auto" loop crossorigin="anonymous" playsinline></video>
            <a-asset-item id="miModelo" src="assets/spiderman.glb"></a-asset-item>
        </a-assets>

        <a-entity light="type: ambient; intensity: 1.2; color: #ffffff"></a-entity>
        <a-entity light="type: directional; intensity: 1.5" position="2 4 4"></a-entity>

        <a-entity camera position="0 1.6 3.5" look-controls="enabled: false"></a-entity>

        <a-entity 
            id="animatedModel"
            gltf-model="#miModelo"
            scale="0.012 0.012 0.012"
            position="0 0 0" 
            rotation="0 0 0"
            model-viewer
        ></a-entity>

    </a-scene>
</body>
</html>
